meta:
  version: 3
  commands:
    test: npm run lint && npm run typecheck && npm test
  conventions:
    commit: '{id}: {short_title}'
    trailers:
      - 'Task-ID: {id}'
      - 'Task-Status: {status}'
  main_mode:
    require_checks: true
    require_task_id_in_subject: true
    use_commit_trailers: true
defaults:
  owner: '@unassigned'
  labels:
    - codex
    - automation
tasks:
  - id: ND-000
    title: Automation readiness check
    priority: P0
    status: done
    tags:
      - automation
      - docs
      - tooling
    files:
      - AGENTS.md
      - todo.yaml
      - scripts/task-tools.ts
      - .github/workflows/ci.yaml
    steps:
      - Validate todo.yaml schema and tasks.
      - Verify AGENTS.md main-commit rules.
      - Verify task-tools CLI and dev deps.
      - Add CI workflow if missing.
      - Mention todo.yaml in README/CONTRIBUTING.
    acceptance:
      - All checks PASS; missing pieces added.
      - Scripts run locally (lint/type/test OK).
    notes: Maintenance/meta task to validate automation.
  - id: ND-001
    title: Offline status indicator
    priority: P0
    status: done
    tags:
      - ui
      - pwa
    files:
      - src/components/notifications/OfflineBanner.tsx
      - src/hooks/use-online.ts
      - src/app/layout.tsx
      - src/hooks/use-online.test.ts
    steps:
      - Create use-online hook (listen to window online/offline).
      - Render a top banner within 2s of going offline; hide within 2s of reconnect.
      - Block network-required actions with a friendly toast while offline.
    acceptance:
      - DevTools offline triggers banner within 2s; hides within 2s on reconnect.
      - Map pans/zooms; no console errors.
      - Unit test stubs navigator.onLine.
    notes: Task originated in todo.md.
  - id: ND-002
    title: Cache note queries in useNotes to reduce Firestore reads
    priority: P1
    status: done
    tags:
      - perf
      - pwa
    files:
      - src/hooks/use-notes.ts
      - src/lib/cache.ts
    steps:
      - LRU cache by geohash window + zoom; TTL 30s; dedupe results.
      - Log cache hits in dev.
    acceptance:
      - Returning to a previous area doesnâ€™t refetch within 30s.
      - Hook API remains unchanged.
    notes: Hook referenced in structure.
  - id: ND-003
    title: Tests for note-sheet-content component
    priority: P2
    status: done
    tags:
      - tests
      - ui
    files:
      - src/components/note-sheet-content.test.tsx
    acceptance:
      - Tests present and passing.
    notes: Already complete.
  - id: ND-004
    title: Notifications button has accessible label
    priority: P2
    status: done
    tags:
      - a11y
      - ui
    files:
      - src/components/notifications-button.tsx
    acceptance:
      - Icon-only button has aria-label or visible text.
    notes: Already complete.
  - id: ND-005
    title: Audit icon-only buttons for accessible labels
    priority: P1
    status: done
    tags:
      - a11y
      - ui
    files:
      - src/components/**/*
    steps:
      - Find icon-only buttons; add aria-label or text.
      - Fix Testing Library queries by role/name.
    acceptance:
      - 'Axe: 0 critical on /, /profile, note sheet.'
    notes: ''
  - id: ND-006
    title: Document required environment variables
    priority: P2
    status: done
    tags:
      - docs
    files:
      - README.md
    acceptance:
      - README lists env vars and example .env.
    notes: Already complete.
  - id: ND-007
    title: Unit tests for content moderation flow
    priority: P0
    status: done
    tags:
      - tests
      - safety
    files:
      - src/ai/flows/content-moderation.ts
      - src/ai/flows/content-moderation.test.ts
    steps:
      - Mock Genkit/Gemini; allow-list and block-list samples.
      - Error case returns 503 with retry guidance.
    acceptance:
      - Allowed sample persists; blocked sample rejected; error handled.
    notes: ''
  - id: ND-008
    title: Tests for report dialog component
    priority: P1
    status: done
    tags:
      - tests
      - ui
    files:
      - src/components/report-dialog.tsx
      - src/components/report-dialog.test.tsx
    steps:
      - Validate required reason; disable submit while pending; success state.
    acceptance:
      - Tests cover happy/invalid/pending paths.
    notes: ''
  - id: ND-009
    title: Rate limiting for reportNoteFlow
    priority: P1
    status: done
    tags:
      - api
      - safety
      - tests
    files:
      - src/ai/flows/report-note-flow.ts
      - src/lib/rate-limit.ts
      - src/ai/flows/report-note-flow.test.ts
      - src/ai/flows/report-note.ts
    steps:
      - 5 reports/10min per UID; 20/hr per IP.
      - Hide note at threshold (default 3; env configurable).
    acceptance:
      - Limits enforced; threshold hide; tests included.
    notes: ''
  - id: ND-010
    title: 'Service Worker: cache note images (SWR)'
    priority: P1
    status: todo
    tags:
      - pwa
      - perf
      - tests
    files:
      - public/service-worker.js
      - src/sw.ts
      - src/sw.test.ts
    steps:
      - Cache /images/notes/* with stale-while-revalidate; cap 100 entries or 20MB.
      - Purge on version bump.
    acceptance:
      - Images load offline; tests simulate fetch/cache.
    notes: ''
  - id: ND-011
    title: Strengthen validation in notify API route
    priority: P0
    status: done
    tags:
      - api
      - safety
    files:
      - src/app/api/notify/route.ts
      - src/lib/validators.ts
      - .env.example
    steps:
      - zod schema for {token,title,body}; max body 2KB.
      - Return structured 400/401/429/5xx errors.
    acceptance:
      - Manual curl tests pass; invalid payloads rejected.
    notes: ''
  - id: ND-012
    title: Provide .env.example and remove real keys
    priority: P2
    status: done
    tags:
      - docs
      - safety
    files:
      - .env.example
      - README.md
    acceptance:
      - .env.example exists with placeholders; README references it.
    notes: Already complete.
  - id: ND-013
    title: Tests for notify API route
    priority: P0
    status: done
    tags:
      - tests
      - api
    files:
      - src/app/api/notify/route.test.ts
    steps:
      - Mock FCM; test success + invalid + unauth + rate-limit.
    acceptance:
      - All cases pass in Vitest; coverage includes error paths.
    notes: ''
  - id: ND-014
    title: Switch to commit trailers
    priority: P0
    status: done
    tags:
      - automation
      - tooling
    files:
      - AGENTS.md
      - todo.yaml
      - scripts/task-tools.ts
      - scripts/task-trailers.ts
      - package.json
    acceptance:
      - Trailers replace SHA recording; tasks CLI updated; commit history report available.
    notes: ''
  - id: ND-015
    title: Document NOTIFY_SECRET environment variable
    priority: P2
    status: todo
    tags:
      - docs
    steps:
      - Explain purpose of NOTIFY_SECRET in README.
    acceptance:
      - README mentions NOTIFY_SECRET.
    notes: ''
  - id: ND-016
    title: Remove unused exports (150) across 42 files
    priority: P2
    status: todo
    tags:
      - cleanup
      - techdebt
    files:
      - next.config.ts
      - tailwind.config.ts
      - vitest.config.ts
      - src/app/actions.ts
      - src/app/layout.tsx
      - src/app/page.tsx
      - src/hooks/use-orientation.ts
      - src/hooks/use-toast.ts
      - src/lib/cache.ts
      - src/lib/geo.ts
      - src/types/index.ts
      - src/ai/flows/content-moderation.ts
      - src/app/admin/page.tsx
      - src/app/favicon.ico/route.ts
      - src/app/firebase-config.js/route.ts
      - src/app/legal/page.tsx
      - src/app/profile/page.tsx
      - src/components/notifications/OfflineBanner.tsx
      - src/components/ui/accordion.tsx
      - src/components/ui/alert-dialog.tsx
      - src/components/ui/alert.tsx
      - src/components/ui/badge.tsx
      - src/components/ui/button.tsx
      - src/components/ui/calendar.tsx
      - src/components/ui/carousel.tsx
      - src/components/ui/chart.tsx
      - src/components/ui/checkbox.tsx
      - src/components/ui/collapsible.tsx
      - src/components/ui/dialog.tsx
      - src/components/ui/dropdown-menu.tsx
      - src/components/ui/form.tsx
      - src/components/ui/menubar.tsx
      - src/components/ui/nd-icon.tsx
      - src/components/ui/popover.tsx
      - src/components/ui/radio-group.tsx
      - src/components/ui/scroll-area.tsx
      - src/components/ui/select.tsx
      - src/components/ui/sheet.tsx
      - src/components/ui/sidebar.tsx
      - src/components/ui/table.tsx
      - src/components/ui/toast.tsx
      - src/app/demo/sketch/page.tsx
    steps:
      - >-
        Delete unused exports or mark as intentional with // eslint-disable-next-line
        import/no-unused-modules
    acceptance:
      - ts-prune reports 0 items (or justified ignores)
    notes: ''
  - id: ND-017
    title: Bug hunt follow-ups
    priority: P2
    status: done
    tags:
      - docs
    notes: Identified bugs and added tasks.
  - id: ND-018
    title: Address npm audit issues (crit:117 high:0 mod:2 low:3)
    priority: P1
    status: done
    tags:
      - security
      - deps
    steps:
      - Review `npm audit` and run `npm audit fix` where safe.
      - Pin or replace vulnerable dependencies.
    acceptance:
      - '`npm audit` reports 0 critical/high vulnerabilities.'
    notes: ''
  - id: ND-019
    title: Fix MapView test mock to forward ref
    priority: P2
    status: todo
    tags:
      - tests
    files:
      - src/components/map-view.test.tsx
    steps:
      - Wrap Map mock with `React.forwardRef` so ref is accepted.
    acceptance:
      - No "Function components cannot be given refs" warning.
    notes: ''
  - id: ND-020
    title: Adjust next/image mock to avoid fill boolean attribute
    priority: P2
    status: todo
    tags:
      - tests
    files:
      - src/components/note-view.test.tsx
    steps:
      - Remove boolean `fill` prop from mocked `<img>` or handle appropriately.
    acceptance:
      - No warning about non-boolean `fill` attribute.
    notes: ''
  - id: ND-021
    title: Clean up DropdownMenu mock to handle onOpenChange
    priority: P2
    status: todo
    tags:
      - tests
    files:
      - src/components/notifications-button.test.tsx
    steps:
      - Ensure mock does not pass `onOpenChange` to DOM elements.
    acceptance:
      - No warning about unknown event handler `onOpenChange`.
    notes: ''
  - id: ND-022
    title: Fix todo.yaml indentation to allow task parsing
    priority: P0
    status: done
    tags:
      - tooling
    files:
      - todo.yaml
    steps:
      - Correct malformed indentation in ND-018 entry.
    acceptance:
      - ts-node scripts/task-tools.ts next runs without YAML errors.
    notes: ''
  - id: ND-028
    title: Stabilize ReportDialog tests and a11y name
    priority: P0
    status: done
    tags:
      - tests
      - a11y
      - ui
    files:
      - src/components/report-dialog.test.tsx
      - src/components/report-dialog.tsx
    steps:
      - Scope queries to the active dialog in tests.
      - Ensure single submit button toggles disabled during pending.
      - Give ReportDialog an accessible name.
    acceptance:
      - Vitest passes for ReportDialog without multiple elements error.
      - Dialog discoverable by role and name for screen readers.
      - Single submit button becomes disabled during pending.
    notes: ''
  - id: ND-029
    title: Sync todo lists
    priority: P2
    status: done
    tags:
      - docs
      - meta
    files:
      - todo.md
      - todo.yaml
    steps:
      - Mark completed tasks in todo.md based on todo.yaml
      - Add missing tasks from backlog to todo.md
    acceptance:
      - todo.md matches tasks and statuses in todo.yaml
    notes: ''
